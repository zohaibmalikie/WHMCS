function initStripe(){var e=jQuery('input[name="paymentmethod"]'),t=jQuery("#frmCheckout"),i=jQuery(".frm-credit-card-input"),n=jQuery("#frmPayment"),r=jQuery("#frmCreditCardDetails");if(e.length&&!i.length){var s=jQuery("#newCardInfo");insertAndMountElementsDivAfterInput(s),elementsDiv=jQuery("#stripeElements");var a=(jQuery('input[name="ccinfo"]'),jQuery('input[name="ccinfo"]:checked')),d=jQuery('input[name="paymentmethod"]:checked').val(),o=jQuery("#existingCardInfo");"undefined"==typeof d&&(d=jQuery('input[name="paymentmethod"]').val()),enablePaymentRequestButton(),"stripe"===d&&(hide_cc_fields(),enable_stripe(),"new"!==a.val()&&(get_existing_token(a.val()),elementsDiv.slideUp(),t.off("submit.stripe"),o.slideUp(),"000"!==amount&&t.on("submit.stripe",processExisting))),e.on("ifChecked",function(){if(d=jQuery(this).val(),"stripe"===d){var e=jQuery('input[name="ccinfo"]:checked').val();hide_cc_fields(),enable_stripe(),"new"!==e&&(get_existing_token(e),elementsDiv.slideUp(),t.off("submit.stripe"),"000"!==amount&&t.on("submit.stripe",processExisting))}else disable_stripe()}),jQuery(document).on("ifChecked",'input[name="ccinfo"]',function(){t.off("submit.stripe"),d=jQuery('input[name="paymentmethod"]:checked').val(),"stripe"===d&&(hide_cc_fields(),"new"===jQuery(this).val()?enable_stripe():(get_existing_token(jQuery(this).val()),elementsDiv.slideUp(),t.off("submit.stripe"),"000"!==amount&&t.on("submit.stripe",processExisting)))})}else if(i.length)"stripe"===jQuery('input[name="type"]:checked').data("gateway")&&(insertAndMountElementsDivBeforeInput(i.find("div.cc-details")),elementsDiv=jQuery("#stripeElements"),hide_cc_fields(),elementsDiv.slideDown(),card.addEventListener("change",cardListener),cardExpiryElements.addEventListener("change",cardListener),cardCvcElements.addEventListener("change",cardListener),i.on("submit.stripe",addNewCardClientSide)),jQuery('input[name="type"]').on("ifChecked",function(){"stripe"===jQuery(this).data("gateway")?(insertAndMountElementsDivBeforeInput(i.find("div.cc-details")),elementsDiv=jQuery("#stripeElements"),hide_cc_fields(),elementsDiv.slideDown(),i.off("submit.stripe"),i.on("submit.stripe",addNewCardClientSide),card.addEventListener("change",cardListener),cardExpiryElements.addEventListener("change",cardListener),cardCvcElements.addEventListener("change",cardListener)):(disable_stripe(),i.find(".cc-details").slideDown())});else if(n.length)insertAndMountElementsDivBeforeInput(n.find("#billingAddressChoice")),n.find("#inputCardCvv").closest("div.form-group").remove(),n.off("submit",validateCreditCardInput),"new"===jQuery('input[name="ccinfo"]:checked').val()?enable_payment_stripe():(get_existing_token(jQuery('input[name="ccinfo"]:checked').val()),n.on("submit.stripe",processExisting)),jQuery('input[name="ccinfo"]').on("ifChecked",function(){"new"===jQuery(this).val()?enable_payment_stripe():(get_existing_token(jQuery(this).val()),jQuery("#stripeElements").slideUp(),n.off("submit.stripe"),n.on("submit.stripe",processExisting),card.hasRegisteredListener("change")&&card.removeEventListener("change",cardListener))}),enablePaymentRequestButton();else if(r.length)if(r.find("#cctype").closest("tr").slideUp().remove(),r.find("#inputCardNumber").closest("div").html('<div id="elementCardNumber" class="form-control"></div>'),r.find("#inputCardExpiry").closest("div").html('<div id="elementCardExpiry" class="form-control"></div>'),r.find("#cardcvv").closest("div").html('<div id="elementCardCvc" class="form-control"></div>'),card.mount("#elementCardNumber"),cardExpiryElements.mount("#elementCardExpiry"),cardCvcElements.mount("#elementCardCvc"),card.addEventListener("change",cardListener),cardExpiryElements.addEventListener("change",cardListener),cardCvcElements.addEventListener("change",cardListener),elementsDiv=jQuery("#elementCardNumber"),jQuery("#containerStorageInputControl")){var l=jQuery("#modalAjaxFooter"),c=l.find("#btnSave");c.removeAttr("name"),c.off(),c.on("click",validateChangeCard),modalInput=!0}else r.find("#btnSaveChanges").removeAttr("name"),r.on("submit.stripe",validateChangeCard)}function validateStripe(e){var t=jQuery('input[name="paymentmethod"]:checked'),i=elementsDiv.closest("form"),n=jQuery(".gateway-errors,.assisted-cc-input-feedback").first();return!(!t.length||"stripe"===t.val())||(e.preventDefault(),i.find('button[type="submit"],input[type="submit"]').prop("disabled",!0).addClass("disabled").find("span").toggle(),stripe.createPaymentMethod("card",card).then(function(e){if(e.error){var t=e.error.message;t&&(n.html(t),n.not(":visible")&&n.slideDown(),scrollToGatewayInputError())}else WHMCS.http.jqClient.jsonPost({url:WHMCS.utils.getRouteUrl("/stripe/payment/intent"),data:i.serialize()+"&payment_method_id="+e.paymentMethod.id,success:function(e){e.success?stripeResponseHandler(e.token):e.two_factor?stripeResponseHandler(""):e.validation_feedback?(n.html(e.validation_feedback),n.not(":visible")&&n.slideDown(),scrollToGatewayInputError(),WHMCS.form.reloadCaptcha()):stripe.handleCardPayment(e.token,card).then(function(e){if(e.error){var t=e.error.message;t&&(n.html(t),n.not(":visible")&&n.slideDown(),scrollToGatewayInputError(),WHMCS.form.reloadCaptcha())}else stripeResponseHandler(e.paymentIntent.id)})},warning:function(e){WHMCS.form.reloadCaptcha(),n.html(defaultErrorMessage),n.not(":visible")&&n.slideDown(),scrollToGatewayInputError()},fail:function(e){n.html(defaultErrorMessage),n.not(":visible")&&n.slideDown(),scrollToGatewayInputError()}})}),!1)}function processExisting(e){var t=elementsDiv.closest("form"),i=jQuery(".gateway-errors,.assisted-cc-input-feedback").first();t.find(".gateway-errors").html("").slideUp(),e.preventDefault(),t.find('button[type="submit"],input[type="submit"]').prop("disabled",!0).addClass("disabled").find("span").toggle(),WHMCS.http.jqClient.jsonPost({url:WHMCS.utils.getRouteUrl("/stripe/payment/intent"),data:t.serialize()+"&payment_method_id="+existingToken,success:function(e){e.success?stripeResponseHandler(e.token):e.validation_feedback?(i.html(e.validation_feedback),i.not(":visible")&&i.slideDown(),scrollToGatewayInputError(),WHMCS.form.reloadCaptcha()):stripe.handleCardPayment(e.token).then(function(e){if(e.error){var t=e.error.message;t&&(i.html(t),i.not(":visible")&&i.slideDown(),scrollToGatewayInputError(),WHMCS.form.reloadCaptcha())}else stripeResponseHandler(e.paymentIntent.id)})},warning:function(e){WHMCS.form.reloadCaptcha(),i.html(defaultErrorMessage),i.not(":visible")&&i.slideDown(),scrollToGatewayInputError()},fail:function(e){i.html(defaultErrorMessage),i.not(":visible")&&i.slideDown(),scrollToGatewayInputError()}})}function stripeResponseHandler(e){var t=elementsDiv.closest("form");t.find(".gateway-errors,.assisted-cc-input-feedback").html("").slideUp(),t.append(jQuery('<input type="hidden" name="remoteStorageToken">').val(e)),t.find('button[type="submit"],input[type="submit"]').find("i.fas,i.far,i.fal,i.fab").removeAttr("class").addClass("fas fa-spinner fa-spin"),modalInput||elementsDiv.slideUp(),t.off("submit.stripe"),t.append('<input type="submit" id="hiddenSubmit" name="submit" value="Save Changes" style="display:none;">');var i=jQuery("#hiddenSubmit");if(modalInput){var n=jQuery("#modalAjaxFooter"),i=n.find("#btnSave");i.removeClass("disabled"),jQuery("#modalAjax .loader").fadeOut(),i.off("click",validateChangeCard),i.on("click",submitIdAjaxModalClickEvent)}i.click()}function hide_cc_fields(){var e=elementsDiv.closest("form"),t=jQuery("#newCardInfo,.cc-details,#existingCardInfo");t.is(":visible")&&t.slideUp("fast",function(){e.find("#cctype").removeAttr("name"),e.find("#inputCardCvvExisting").removeAttr("name"),e.find("#inputCardNumber").removeAttr("name"),e.find("#inputCardExpiry").removeAttr("name"),e.find("#inputCardCVV").removeAttr("name"),e.find("#inputCardCvvExisting").removeAttr("name")})}function enable_stripe(){var e=elementsDiv.closest("form"),t=jQuery("#inputDescriptionContainer");hide_cc_fields(),elementsDiv.slideDown(),card.addEventListener("change",cardListener),cardExpiryElements.addEventListener("change",cardListener),cardCvcElements.addEventListener("change",cardListener),e.off("submit.stripe"),"000"===amount?e.on("submit.stripe",addNewCardClientSide):e.on("submit.stripe",validateStripe),t.addClass("col-md-offset-3 offset-md-3")}function disable_stripe(){var e=elementsDiv.closest("form"),t=jQuery("#newCardInfo,.cc-details"),i=!0,n=jQuery("#inputDescriptionContainer");e.find("#inputCardCvvExisting").attr("name","cccvvexisting"),e.find("#inputCardNumber").attr("name","ccnumber"),e.find("#inputCardExpiry").attr("name","ccexpirydate"),e.find("#inputCardCVV").attr("name","cccvv"),e.find("#inputCardCvvExisting").attr("name","cccvvexisting"),e.find("#cctype").attr("name","cctype"),1===jQuery('input[name="paymentmethod"]:checked').data("remote-inputs")&&(i=!1),elementsDiv.hide("fast",function(){var e=jQuery('input[name="ccinfo"]:visible').first();"new"===e.val()?i&&t.slideDown():e.click()}),e.off("submit.stripe"),card.hasRegisteredListener("change")&&card.removeEventListener("change",cardListener),cardExpiryElements.hasRegisteredListener("change")&&cardExpiryElements.removeEventListener("change",cardListener),cardCvcElements.hasRegisteredListener("change")&&cardCvcElements.removeEventListener("change",cardListener),n.removeClass("col-md-offset-3 offset-md-3")}function enable_payment_stripe(){var e=elementsDiv.closest("form");e.find("#inputCardNumber").closest("div.form-group").remove(),e.find("#inputCardExpiry").closest("div.form-group").remove(),elementsDiv.slideDown(),card.addEventListener("change",cardListener),cardExpiryElements.addEventListener("change",cardListener),cardCvcElements.addEventListener("change",cardListener),e.off("submit.stripe"),e.on("submit.stripe",validateStripe)}function enablePaymentRequestButton(){if(paymentRequestButtonEnabled){var e=(elementsDiv.closest("form"),stripe.paymentRequest({country:"US",currency:paymentRequestCurrency.toLowerCase(),total:{label:paymentRequestDescription,amount:paymentRequestAmountDue},requestPayerName:!0,requestPayerEmail:!0})),t=jQuery(".gateway-errors,.assisted-cc-input-feedback").first(),i=elements.create("paymentRequestButton",{paymentRequest:e});e.canMakePayment().then(function(e){e&&(e.applePay,0===jQuery("#paymentRequestButton").length&&elementsDiv.prepend('<div class="row"><div class="col-md-4 col-md-offset-4 offset-md-4"><div id="paymentRequestButton"></div></div></div>'),i.mount("#paymentRequestButton"))}),e.on("paymentmethod",function(e){var i=e.paymentMethod.id,n=null,r=e,s=elementsDiv.closest("form");s.find(".gateway-errors,.assisted-cc-input-feedback").html("").slideUp(),s.find('button[type="submit"],input[type="submit"]').addClass("disabled").prop("disabled",!0).find("i.fas,i.far,i.fal,i.fab").removeAttr("class").addClass("fas fa-spinner fa-spin"),WHMCS.http.jqClient.jsonPost({url:WHMCS.utils.getRouteUrl("/stripe/payment/intent"),data:s.serialize()+"&payment_method_id="+i,success:function(e){n=e.token,e.success?(r.complete("success"),stripeResponseHandler(e.token)):e.validation_feedback?(t.html(e.validation_feedback),t.not(":visible")&&t.slideDown(),scrollToGatewayInputError(),WHMCS.form.reloadCaptcha()):stripe.handleCardPayment(n).then(function(e){if(e.error){var i=e.error.message;i&&(t.html(i),t.not(":visible")&&t.slideDown(),scrollToGatewayInputError(),WHMCS.form.reloadCaptcha())}else stripeResponseHandler(e.paymentIntent.id)}),WHMCS.form.reloadCaptcha()},warning:function(e){WHMCS.form.reloadCaptcha(),t.html(defaultErrorMessage),t.not(":visible")&&t.slideDown(),scrollToGatewayInputError()},fail:function(e){t.html(defaultErrorMessage),t.not(":visible")&&t.slideDown(),scrollToGatewayInputError()}})})}}function insertAndMountElementsDivAfterInput(e){if(elementsDiv=jQuery("#stripeElements"),!elementsDiv.length){e.after(stripe_cc_html(e));var t=jQuery("#stripeCvcWhere");t.length&&(jQuery("#cvvWhereLink").clone().appendTo(t),jQuery('[data-toggle="popover"]').popover({html:!0})),elementsDiv=jQuery("#stripeElements"),card.mount("#stripeCreditCard"),cardExpiryElements.mount("#stripeExpiryDate"),cardCvcElements.mount("#stripeCvc")}}function insertAndMountElementsDivBeforeInput(e){if(elementsDiv=jQuery("#stripeElements"),!elementsDiv.length){e.before(stripe_cc_html(e));var t=jQuery("#stripeCvcWhere");t.length&&(jQuery("#cvvWhereLink").clone().appendTo(t),jQuery('[data-toggle="popover"]').popover({html:!0})),elementsDiv=jQuery("#stripeElements"),card.mount("#stripeCreditCard"),cardExpiryElements.mount("#stripeExpiryDate"),cardCvcElements.mount("#stripeCvc")}}function stripe_cc_html(e){var t=e.closest("form")[0],i="";return"frmCheckout"===t.id?i='<div id="stripeElements" class="form-group" style="display: none;"><div class="stripe-cards-inputs col-md-8 col-md-offset-2 offset-md-2"><div class="row"><div class="col-md-6"><label for="stripeCreditCard">'+lang.creditCardInput+'</label><div id="stripeCreditCard" class="form-control"></div><div id="stripeCardType"></div></div><div class="col-md-3"><label for="stripeExpiryDate">'+lang.creditCardExpiry+'</label><div id="stripeExpiryDate" class="form-control"></div></div><div class="col-md-3"><label for="stripeCvc">'+lang.creditCardCvc+'</label><div id="stripeCvc" class="form-control"></div></div></div></div></div><div class="clearfix"></div>':(elementsClass="",i='<div id="stripeElements" style="display: none;"><div class="form-group row cc-billing-address"><label for="stripeCreditCard" class="col-sm-4 control-label">'+lang.creditCardInput+'</label><div class="col-sm-7"><div id="stripeCreditCard" class="form-control" aria-describedby="cc-type"></div><div id="stripeCardType"></div></div><div class="col-sm-4"></div></div><div class="form-group row cc-billing-address"><label for="stripeExpiryDate" class="col-sm-4 control-label">'+lang.creditCardExpiry+'</label><div class="col-sm-2"><div id="stripeExpiryDate" class="form-control"></div></div><div class="col-sm-6"></div></div><div class="form-group row cc-billing-address"><label for="stripeCvc" class="col-sm-4 control-label">'+lang.creditCardCvc+'</label><div class="col-sm-2"><div id="stripeCvc" class="form-control"></div></div><div class="col-sm-4"><div id="stripeCvcWhere"></div></div></div></div></div><div class="clearfix"></div>'),i}function cardListener(e){var t=jQuery(".gateway-errors,.assisted-cc-input-feedback").first(),i="";"undefined"!=typeof e.error?(i=e.error.message,i&&(t.html(i),t.not(":visible")&&t.slideDown(),scrollToGatewayInputError())):t.slideUp().html(""),"undefined"!=typeof e.brand}function addNewCardClientSide(e){var t=elementsDiv.closest("form"),i=jQuery(".gateway-errors,.assisted-cc-input-feedback").first();e.preventDefault(),t.find('button[type="submit"],input[type="submit"]').prop("disabled",!0).addClass("disabled").find("span").toggle(),WHMCS.http.jqClient.jsonPost({url:WHMCS.utils.getRouteUrl("/stripe/setup/intent"),data:t.serialize(),success:function(e){e.success&&stripe.handleCardSetup(e.setup_intent,card).then(function(e){e.error?(i.html(e.error.message),i.not(":visible")&&i.slideDown(),scrollToGatewayInputError()):stripeResponseHandler(e.setupIntent.id)})},warning:function(e){i.html(e),i.not(":visible")&&i.slideDown(),scrollToGatewayInputError()},fail:function(e){i.html(e),i.not(":visible")&&i.slideDown(),scrollToGatewayInputError()}})}function validateChangeCard(e){var t=elementsDiv.closest("form"),i=jQuery(".gateway-errors,.assisted-cc-input-feedback").first();return e.preventDefault(),t.find('button[type="submit"],input[type="submit"]').prop("disabled",!0).addClass("disabled").find("span").toggle(),stripe.createPaymentMethod("card",card).then(function(e){if(e.error){var n=e.error.message;n&&(i.html(n),i.not(":visible")&&i.slideDown(),scrollToGatewayInputError())}else{if(modalInput){var r=jQuery("#btnSave");r.addClass("disabled"),jQuery("#modalAjax .loader").slideDown()}if("undefined"!=typeof WHMCS.utils)var s=WHMCS.utils.getRouteUrl("/stripe/payment/add");else var s=WHMCS.adminUtils.getAdminRouteUrl("/stripe/payment/admin/add");WHMCS.http.jqClient.jsonPost({url:s,data:t.serialize()+"&payment_method_id="+e.paymentMethod.id,success:function(e){e.success&&stripeResponseHandler(e.token),e.validation_feedback&&(i.text(e.validation_feedback),i.not(":visible")&&i.slideDown())},warning:function(e){i.html(e),i.not(":visible")&&i.slideDown(),scrollToGatewayInputError()},fail:function(e){i.html(e),i.not(":visible")&&i.slideDown(),scrollToGatewayInputError()},always:function(){modalInput&&(r.removeClass("disabled"),jQuery("#modalAjax .loader").fadeOut())}})}}),!1}function get_existing_token(e){if("undefined"==typeof e){var t=jQuery('input[name="ccinfo"]:visible:first');if(t.iCheck("check"),e=t.val(),"new"===e)return}var i=jQuery(".gateway-errors,.assisted-cc-input-feedback").first(),n=i.closest("form");n.find('button[type="submit"],input[type="submit"]').prop("disabled",!0).addClass("disabled").find("span").toggle(),WHMCS.http.jqClient.jsonPost({url:WHMCS.utils.getRouteUrl("/payment/stripe/token/get"),data:"paymethod_id="+e+"&token="+csrfToken,success:function(e){existingToken=e.token,n.find('button[type="submit"],input[type="submit"]').prop("disabled",!1).removeClass("disabled").find("span").toggle()},warning:function(e){i.html(e),i.not(":visible")&&i.slideDown(),scrollToGatewayInputError(),reset_input_to_new()},fail:function(e){i.html(e),i.not(":visible")&&i.slideDown(),scrollToGatewayInputError(),reset_input_to_new()}})}function reset_input_to_new(){jQuery('input[name="ccinfo"][value="new"]').iCheck("check"),jQuery("#existingCardInfo").is(":visible")&&jQuery("#existingCardInfo").slideUp(),setTimeout(function(){jQuery(".gateway-errors,.assisted-cc-input-feedback").slideUp()},4e3)}var elementsDiv=null,modalInput=!1;